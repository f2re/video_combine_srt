# Сервис обработки видео: Объединение и Анимированные Субтитры

## Описание

Этот проект представляет собой Flask-приложение, предназначенное для обработки видеофайлов. Основные функции включают загрузку видео из различных источников (в том числе с использованием xAPI заголовков), их объединение в один файл и добавление анимированных ("бегущих" или караоке-стиль) субтитров. Если автоматическая генерация анимированных субтитров невозможна или не требуется, система может использовать предоставленные SRT субтитры или создать видео с простыми статичными субтитрами.

Сервис работает асинхронно, позволяя отслеживать статус выполнения задач и скачивать результат по их завершении.

## Основные возможности

*   **Загрузка видео**: Поддержка загрузки видео по прямым URL, а также через `piapi_data` с кастомными xAPI заголовками.
*   **Объединение видео**: Склеивание нескольких видеофрагментов в единый видеофайл. Система автоматически определяет наличие аудиодорожек в исходных видео для корректного объединения.
*   **Автоматические субтитры**: Генерация субтитров с таймкодами на уровне отдельных слов с использованием моделей Whisper (если соответствующая библиотека доступна).
*   **Пользовательские субтитры**: Возможность предоставления собственных субтитров в формате `.srt` через тело запроса к webhook.
*   **Анимированные субтитры**: Создание видео с эффектом "бегущей строки" (караоке) на основе сгенерированных или предоставленных таймкодов (в формате ASS).
*   **Резервный механизм**: Если создание анимированных субтитров невозможно (например, отсутствует аудио или Whisper недоступен), создается видео с обычными статичными субтитрами (SRT).
*   **Асинхронная обработка**: Задачи выполняются в фоновом режиме, не блокируя основной поток.
*   **API**: HTTP API для:
    *   Отправки задач на обработку (`/webhook`).
    *   Проверки статуса выполнения задачи (`/status/<task_id>`).
    *   Скачивания готового видеофайла (`/download/<task_id>`).

## Технологический стек

*   **Язык**: Python 3
*   **Веб-фреймворк**: Flask
*   **Обработка видео**: FFmpeg (через `ffmpeg-python`)
*   **Распознавание речи и генерация таймкодов**: Whisper (OpenAI Whisper, faster-whisper)
*   **Работа с SRT субтитрами**: `pysrt`
*   **HTTP запросы**: `requests`

## Установка

1.  **Клонируйте репозиторий** (если это еще не сделано):
    ```bash
    git clone <URL_репозитория>
    cd video_combine
    ```

2.  **Создайте и активируйте виртуальное окружение**:
    ```bash
    python3 -m venv venv
    source venv/bin/activate  # для Linux/macOS
    # venv\Scripts\activate   # для Windows
    ```

3.  **Установите FFmpeg**:
    FFmpeg должен быть установлен в вашей системе и доступен в PATH. Инструкции по установке можно найти на [официальном сайте FFmpeg](https://ffmpeg.org/download.html).
    *   Для macOS (используя Homebrew):
        ```bash
        brew install ffmpeg
        ```
    *   Для Debian/Ubuntu:
        ```bash
        sudo apt update
        sudo apt install ffmpeg
        ```

4.  **Установите зависимости Python**:
    ```bash
    pip install -r requirements.txt
    ```
    Для полной функциональности, включая автоматическую генерацию субтитров с помощью Whisper, убедитесь, что установлены все пакеты, указанные при запуске скрипта (они должны быть в `requirements.txt`):
    `flask, requests, ffmpeg-python, pysrt, whisper, openai-whisper, faster-whisper, moviepy`

## Запуск приложения

После установки всех зависимостей, запустите Flask-приложение:

```bash
python main.py
```

Сервер будет запущен по умолчанию на `http://localhost:9000`. В консоли вы увидите доступные эндпоинты.

## Использование API

### 1. Отправка задачи на обработку

*   **URL**: `/webhook`
*   **Метод**: `POST`
*   **Тело запроса**: JSON

    ```json
    {
        "videos": [
            // Вариант 1: Прямой URL
            "http://example.com/path/to/video1.mp4",
            // Вариант 2: Объект с ключом "url"
            { "url": "http://example.com/path/to/video2.mp4" },
            // Вариант 3: Объект с "piapi_data" для xAPI заголовков
            {
                "piapi_data": {
                    "url": "http://example.com/path/to/video3.mp4",
                    "headers": {
                        "X-Custom-Header": "SomeValue",
                        "Authorization": "Bearer your_token_here"
                    }
                }
            },
            // Вариант 4: Объект с ключом "uri" или "link"
            { "uri": "http://example.com/path/to/video4.mp4" }
        ],
        "srt": "1\n00:00:00,000 --> 00:00:02,500\nПервая строка субтитров.\n\n2\n00:00:03,100 --> 00:00:05,800\nВторая строка субтитров."
    }
    ```

    *   `videos` (обязательный): Массив строк или объектов, описывающих видео для загрузки и объединения. Каждый элемент может быть:
        *   Простой строкой URL.
        *   Объектом с ключом `url`.
        *   Объектом с ключом `piapi_data`, который содержит `url` и `headers` для xAPI.
        *   Объектом с ключом `uri` или `link`.
    *   `srt` (опциональный): Строка, содержащая полные данные SRT-субтитров. Если предоставлены, система попытается использовать их для создания анимированных субтитров.

*   **Успешный ответ (200 OK)**:
    ```json
    {
        "task_id": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
        "status": "processing",
        "message": "Начата обработка N видео с прокручивающимися субтитрами",
        "video_count": N,
        "has_custom_subtitles": true // или false
    }
    ```

### 2. Проверка статуса задачи

*   **URL**: `/status/<task_id>`
*   **Метод**: `GET`
*   `<task_id>`: Идентификатор задачи, полученный при ее создании.

*   **Пример ответа (статус `processing`)**:
    ```json
    {
        "task_id": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
        "status": "processing",
        "progress": 50, // Прогресс в процентах
        "created_at": "YYYY-MM-DDTHH:MM:SS.ffffff",
        "video_count": N,
        "has_custom_subtitles": true
    }
    ```

*   **Пример ответа (статус `completed`)**:
    ```json
    {
        "task_id": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
        "status": "completed",
        "progress": 100,
        "created_at": "YYYY-MM-DDTHH:MM:SS.ffffff",
        "video_count": N,
        "has_custom_subtitles": true,
        "download_url": "/download/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
        "output_file": "output_videos/final_scrolling_subtitles_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx.mp4"
    }
    ```

*   **Пример ответа (статус `error`)**:
    ```json
    {
        "task_id": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
        "status": "error",
        "progress": 0, // или значение на момент ошибки
        "created_at": "YYYY-MM-DDTHH:MM:SS.ffffff",
        "video_count": N,
        "has_custom_subtitles": true,
        "error": "Описание ошибки"
    }
    ```

### 3. Скачивание результата

*   **URL**: `/download/<task_id>`
*   **Метод**: `GET`
*   `<task_id>`: Идентификатор выполненной задачи.

    Сервер отправит видеофайл `final_scrolling_subtitles_<task_id>.mp4` для скачивания.

## Пример полного рабочего процесса

1.  **Отправьте POST-запрос на `/webhook`** с данными ваших видео (и, возможно, SRT).
    ```bash
    curl -X POST -H "Content-Type: application/json" -d '{
      "videos": ["http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerFun.mp4"],
      "srt": "1\n00:00:01,000 --> 00:00:03,000\nHello world!\n\n2\n00:00:03,500 --> 00:00:05,000\nThis is a test."
    }' http://localhost:9000/webhook
    ```
    Запомните `task_id` из ответа.

2.  **Периодически проверяйте статус GET-запросом на `/status/<task_id>`** до тех пор, пока статус не станет `completed` или `error`.
    ```bash
    curl http://localhost:9000/status/your_task_id_here
    ```

3.  **Если статус `completed`, скачайте видео**, перейдя по URL из поля `download_url` в браузере или используя curl:
    ```bash
    curl -o my_final_video.mp4 http://localhost:9000/download/your_task_id_here
    ```

## Структура проекта

*   `main.py`: Основной файл приложения, содержащий логику Flask, классы `VideoDownloader` и `VideoProcessor`, и обработчики API.
*   `requirements.txt`: Список Python-зависимостей.
*   `.gitignore`: Файл для исключения ненужных файлов из Git.
*   `temp_files/`: Директория для временных файлов, создаваемых в процессе обработки (например, загруженные части видео, файлы субтитров).
*   `output_videos/`: Директория для сохранения конечных обработанных видеофайлов.

## Важные замечания

*   **FFmpeg**: Убедитесь, что FFmpeg корректно установлен и доступен в системном PATH. Без него обработка видео невозможна.
*   **Whisper**: Для автоматической генерации субтитров и их таймкодов на уровне слов необходима установка Whisper (`openai-whisper`, `faster-whisper`). Если эти библиотеки недоступны, функционал автоматических субтитров будет ограничен, и система будет полагаться на предоставленные SRT или создавать видео без субтитров/с пустыми субтитрами.
*   **Ресурсы**: Обработка видео, особенно с использованием Whisper, может быть ресурсоемкой (CPU, RAM). Учитывайте это при развертывании и использовании.
*   **Очистка**: В текущей реализации задачи хранятся в памяти (`TASKS` словарь). При перезапуске сервера информация о задачах будет утеряна. Временные файлы в `temp_files` и `output_videos` не удаляются автоматически после скачивания.
